name: Event Data Deploy (Post-Merge)

# Builds and deploys event-data pages after an event PR merges to main.
# Uses setup-node with npm cache to install only production dependencies.
#
# All deploy jobs start immediately in parallel — no serial detect job.
# Each job performs its own inline detection of changed event data files.
#
# Jobs:
#   1. deploy-qa      – detect inline + build + rsync to QA
#   2. deploy-prod    – detect inline + QA check + build + SCP to Production

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'source/data/**.yaml'

jobs:
  deploy-qa:
    name: Build & deploy to QA
    runs-on: ubuntu-latest
    environment: qa

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed event data file
        id: gate
        run: |
          CHANGED=$(git diff --name-only HEAD~1..HEAD \
            | grep '^source/data/' | grep '\.yaml$' \
            | grep -v 'camps\.yaml' | grep -v 'local\.yaml' | head -1)
          if [ -z "$CHANGED" ]; then
            echo "No event YAML file changed"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Detected changed file: $CHANGED"
          fi

      - uses: actions/setup-node@v4
        if: steps.gate.outputs.skip != 'true'
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install production dependencies
        if: steps.gate.outputs.skip != 'true'
        run: npm ci --omit=dev

      - name: Build site
        if: steps.gate.outputs.skip != 'true'
        run: node source/build/build.js
        env:
          API_URL: ${{ secrets.API_URL }}
          SITE_URL: ${{ secrets.SITE_URL }}
          BUILD_ENV: qa

      - name: Stage event data pages
        if: steps.gate.outputs.skip != 'true'
        run: |
          mkdir -p staging
          for FILE in schema.html idag.html dagens-schema.html events.json schema.rss schema.ics kalender.html; do
            if [ -f "public/$FILE" ]; then
              cp "public/$FILE" "staging/$FILE"
              echo "Staged: $FILE"
            fi
          done
          if [ -d "public/schema" ]; then
            find public/schema \( -name 'index.html' -o -name 'event.ics' \) | while read -r PAGE; do
              REL="${PAGE#public/}"
              mkdir -p "staging/$(dirname "$REL")"
              cp "$PAGE" "staging/$REL"
              echo "Staged: $REL"
            done
          fi

      - name: Upload event data pages via rsync
        if: steps.gate.outputs.skip != 'true'
        run: |
          install -m 600 /dev/null deploy_key
          echo "${{ secrets.SERVER_SSH_KEY }}" > deploy_key
          rsync -avz \
            -e "ssh -p ${{ secrets.SERVER_SSH_PORT }} -o StrictHostKeyChecking=no -i deploy_key" \
            staging/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_DIR }}/public_html/
          rm -f deploy_key

  deploy-prod:
    name: Build & deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Detect changed event data file and check QA status
        id: gate
        run: |
          CHANGED=$(git diff --name-only HEAD~1..HEAD \
            | grep '^source/data/' | grep '\.yaml$' \
            | grep -v 'camps\.yaml' | grep -v 'local\.yaml' | head -1)
          if [ -z "$CHANGED" ]; then
            echo "No event YAML file changed"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            BASENAME=$(basename "$CHANGED")
            IS_QA=$(node -e "
              const fs = require('fs');
              const yaml = require('js-yaml');
              const camps = yaml.load(fs.readFileSync('source/data/camps.yaml','utf8'));
              const match = camps.camps.find(c => c.file === '$BASENAME');
              console.log(match && match.qa === true ? 'true' : 'false');
            ")
            if [ "$IS_QA" = "true" ]; then
              echo "File $BASENAME belongs to QA camp — skipping production deploy"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "Detected changed file: $CHANGED (not QA)"
            fi
          fi

      - name: Build site
        if: steps.gate.outputs.skip != 'true'
        run: node source/build/build.js
        env:
          API_URL: ${{ secrets.API_URL }}
          SITE_URL: ${{ secrets.SITE_URL }}
          BUILD_ENV: production

      - name: Stage event data pages
        if: steps.gate.outputs.skip != 'true'
        run: |
          mkdir -p staging
          for FILE in schema.html idag.html dagens-schema.html events.json schema.rss schema.ics kalender.html; do
            if [ -f "public/$FILE" ]; then
              cp "public/$FILE" "staging/$FILE"
              echo "Staged: $FILE"
            fi
          done
          if [ -d "public/schema" ]; then
            find public/schema \( -name 'index.html' -o -name 'event.ics' \) | while read -r PAGE; do
              REL="${PAGE#public/}"
              mkdir -p "staging/$(dirname "$REL")"
              cp "$PAGE" "staging/$REL"
              echo "Staged: $REL"
            done
          fi

      - name: Upload event data pages via SCP
        if: steps.gate.outputs.skip != 'true'
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: staging/*
          target: ${{ secrets.DEPLOY_DIR }}/public_html
          strip_components: 1
