name: Event Data Deploy (Post-Merge)

# Builds and deploys event-data pages after an event PR merges to main.
# Uses a pre-built Docker image from GHCR to skip npm ci.
#
# Jobs:
#   1. detect     – identify changed YAML file and QA-camp status
#   2. deploy-qa  – build + SCP to QA (parallel)
#   3. deploy-qa-node – build + SCP to QA Node (parallel)
#   4. deploy-prod – build + SCP to Production (parallel, skipped for QA camps)

permissions:
  contents: read
  packages: read

on:
  push:
    branches:
      - main
    paths:
      - 'source/data/**.yaml'

jobs:
  detect:
    name: Detect changed file
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      yaml_file: ${{ steps.changed.outputs.yaml_file }}
      is_qa: ${{ steps.qa-check.outputs.is_qa }}
      has_event_data: ${{ steps.changed.outputs.has_event_data }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed event YAML file
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1..HEAD \
            | grep '^source/data/' | grep '\.yaml$' \
            | grep -v 'camps\.yaml' | grep -v 'local\.yaml' | head -1)
          if [ -z "$CHANGED" ]; then
            echo "No event YAML file changed"
            echo "has_event_data=false" >> $GITHUB_OUTPUT
          else
            echo "yaml_file=$CHANGED" >> $GITHUB_OUTPUT
            echo "has_event_data=true" >> $GITHUB_OUTPUT
            echo "Detected changed file: $CHANGED"
          fi

      - name: Check if changed file belongs to a QA camp
        id: qa-check
        if: steps.changed.outputs.has_event_data == 'true'
        run: |
          BASENAME=$(basename "${{ steps.changed.outputs.yaml_file }}")
          IS_QA=$(node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const camps = yaml.load(fs.readFileSync('source/data/camps.yaml','utf8'));
            const match = camps.camps.find(c => c.file === '$BASENAME');
            console.log(match && match.qa === true ? 'true' : 'false');
          ")
          echo "is_qa=$IS_QA" >> $GITHUB_OUTPUT
          echo "File $BASENAME is QA camp: $IS_QA"

  deploy-qa:
    name: Build & deploy to QA
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_event_data == 'true'
    container:
      image: ghcr.io/${{ github.repository }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    environment: qa

    steps:
      - uses: actions/checkout@v4

      - name: Build site
        run: node source/build/build.js
        env:
          API_URL: ${{ secrets.API_URL }}
          SITE_URL: ${{ secrets.SITE_URL }}
          BUILD_ENV: qa

      - name: Stage event data pages
        run: |
          mkdir -p staging
          for FILE in schema.html idag.html dagens-schema.html events.json schema.rss schema.ics kalender.html; do
            if [ -f "public/$FILE" ]; then
              cp "public/$FILE" "staging/$FILE"
              echo "Staged: $FILE"
            fi
          done
          if [ -d "public/schema" ]; then
            find public/schema \( -name 'index.html' -o -name 'event.ics' \) | while read -r PAGE; do
              REL="${PAGE#public/}"
              mkdir -p "staging/$(dirname "$REL")"
              cp "$PAGE" "staging/$REL"
              echo "Staged: $REL"
            done
          fi

      - name: Upload event data pages via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: staging/*
          target: ${{ secrets.DEPLOY_DIR }}/public_html
          strip_components: 1

  deploy-qa-node:
    name: Build & deploy to QA Node
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_event_data == 'true'
    container:
      image: ghcr.io/${{ github.repository }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    environment: qanode

    steps:
      - uses: actions/checkout@v4

      - name: Build site
        run: node source/build/build.js
        env:
          API_URL: ${{ secrets.API_URL }}
          SITE_URL: ${{ secrets.SITE_URL }}
          BUILD_ENV: qa

      - name: Stage event data pages
        run: |
          mkdir -p staging
          for FILE in schema.html idag.html dagens-schema.html events.json schema.rss schema.ics kalender.html; do
            if [ -f "public/$FILE" ]; then
              cp "public/$FILE" "staging/$FILE"
              echo "Staged: $FILE"
            fi
          done
          if [ -d "public/schema" ]; then
            find public/schema \( -name 'index.html' -o -name 'event.ics' \) | while read -r PAGE; do
              REL="${PAGE#public/}"
              mkdir -p "staging/$(dirname "$REL")"
              cp "$PAGE" "staging/$REL"
              echo "Staged: $REL"
            done
          fi

      - name: Upload event data pages via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: staging/*
          target: ${{ secrets.DEPLOY_DIR }}/public_html
          strip_components: 1

  deploy-prod:
    name: Build & deploy to Production
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_event_data == 'true' && needs.detect.outputs.is_qa != 'true'
    container:
      image: ghcr.io/${{ github.repository }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Build site
        run: node source/build/build.js
        env:
          API_URL: ${{ secrets.API_URL }}
          SITE_URL: ${{ secrets.SITE_URL }}
          BUILD_ENV: production

      - name: Stage event data pages
        run: |
          mkdir -p staging
          for FILE in schema.html idag.html dagens-schema.html events.json schema.rss schema.ics kalender.html; do
            if [ -f "public/$FILE" ]; then
              cp "public/$FILE" "staging/$FILE"
              echo "Staged: $FILE"
            fi
          done
          if [ -d "public/schema" ]; then
            find public/schema \( -name 'index.html' -o -name 'event.ics' \) | while read -r PAGE; do
              REL="${PAGE#public/}"
              mkdir -p "staging/$(dirname "$REL")"
              cp "$PAGE" "staging/$REL"
              echo "Staged: $REL"
            done
          fi

      - name: Upload event data pages via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: staging/*
          target: ${{ secrets.DEPLOY_DIR }}/public_html
          strip_components: 1
